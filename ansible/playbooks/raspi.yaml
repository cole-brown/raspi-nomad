---

# Host patterns: https://docs.ansible.com/ansible/latest/user_guide/intro_patterns.html
# `&` is for an intersection of groups/hosts.
- hosts: dc_2021_home:&home_2019_raspi4

  # # ============================================================================
  # # Constants
  # # ============================================================================
  # vars:
  #   foo: "bar"

  # # ============================================================================
  # # Execute the roles.
  # # ============================================================================
  # roles:
  #   - foo.bar
  #   - foo.qux
  #   - narf

  # ============================================================================
  # Tasks:
  # ============================================================================
  tasks:
    # # --------------------------------------------------------------------------
    # # Debug
    # # --------------------------------------------------------------------------
    #
    # - name: Print | Facts
    #   ansible.builtin.debug:
    #     var: ansible_facts
    #
    # - name: Print | Vars | Host
    #   ansible.builtin.debug:
    #     var: hostvars["home_2019_raspi4"]
    #
    # - name: Print | Vars | Group
    #   ansible.builtin.debug:
    #     var: groups


    # --------------------------------------------------------------------------
    # [Set-Up] Gather Facts
    # --------------------------------------------------------------------------
    - name: Git Root | Gather Fact
      delegate_to: localhost
      command:
        cmd: "git rev-parse --show-toplevel"
      register: cmd_git_root
      changed_when: false

    - name: Git Root | Set Fact
      set_fact:
        path_git_root: "{{ cmd_git_root.stdout }}"


    # --------------------------------------------------------------------------
    # [Install] Prerequisites
    # --------------------------------------------------------------------------

    - name: Apt | Install | ca-certificates
      apt:
        name: ca-certificates
        state: present # Just need something installed.
        # state: latest # Make sure latest version is installed.

    - name: Apt | Install | gnupg
      apt:
        name: gnupg
        state: present # Just need something installed.
        # state: latest # Make sure latest version is installed.

    - name: Apt | Install | curl
      apt:
        name: curl
        state: present # Just need something installed.
        # state: latest # Make sure latest version is installed.

    - name: Apt | Install | lsb-release
      apt:
        name: lsb-release
        state: present # Just need something installed.
        # state: latest # Make sure latest version is installed.


    # --------------------------------------------------------------------------
    # [Install] Apt Repos
    # --------------------------------------------------------------------------
    # Add all extra apt repos before we run apt update/upgarde.

    - name: Apt | Docker Repo
      include_tasks: "apt.add-repo.yaml"
      vars:
        repo_item:
          name_display: Docker
          repo:
            # For repos added like: `deb [{{ architecture }} signed-by={{ dearmored }}] URL {{ distribution_release }} BRANCH`
            url: https://download.docker.com/linux/ubuntu
            branch: stable
          key:
            url: https://download.docker.com/linux/ubuntu/gpg
            basename: docker # docker.asc, docker.gpg
            checksum:
              # curl -fsSL https://download.docker.com/linux/ubuntu/gpg > /tmp/docker.asc
              # gpg --dearmor < /tmp/docker.asc | sha1sum
              # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
              # `ansible.builtin.copy` uses `sha1` for checksumming.
              dearmored: "7c67919f823e005af75293a0edac7d0799252213"

    - name: Apt | HashiCorp Repo
      include_tasks: "apt.add-repo.yaml"
      vars:
        repo_item:
          name_display: HashiCorp
          repo:
            # For repos added like: `deb [{{ architecture }}] URL {{ distribution_release }} BRANCH`
            url: https://apt.releases.hashicorp.com/
            branch: main
          key:
            url: https://apt.releases.hashicorp.com/gpg
            basename: hashicorp # hashicorp.asc, hashicorp.gpg
            checksum:
              # gpg --dearmor < /path/to/repo/ansible/gpg/hashicorp.asc | sha1sum
              # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
              # `ansible.builtin.copy` uses `sha1` for checksumming.
              dearmored: "dcece7980f1a183b1d59b26354247a29057786e0"


    # --------------------------------------------------------------------------
    # [Install] Apt Prep.
    # --------------------------------------------------------------------------
    # Update the apt cache and upgrade existing packages.

    - name: Apt | Update Cache
      apt:
        update_cache: true
        cache_valid_time: 3600
      # Don't care if this says the cache was old - only care if that causes other
      # steps to do something. So the status of this isn't as important - those
      # other steps will say if they changed.
      changed_when: false

    - name: Apt | Upgrade
      apt:
        upgrade: yes


    # --------------------------------------------------------------------------
    # [Install] Docker
    # --------------------------------------------------------------------------

    # ------------------------------
    # Install
    # ------------------------------
    - name: Apt | Install | Docker Container Engine
      apt:
        name: docker-ce
        state: present # Just need something installed.
        # state: latest # Make sure latest version is installed.

    - name: Apt | Install | Docker CE CLI
      apt:
        name: docker-ce-cli
        state: present # Just need something installed.
        # state: latest # Make sure latest version is installed.

    - name: Apt | Install | containerd.io
      apt:
        name: containerd.io
        state: present # Just need something installed.
        # state: latest # Make sure latest version is installed.

    - name: Apt | Install | Docker Compose Plugin
      apt:
        name: docker-compose-plugin
        state: present # Just need something installed.
        # state: latest # Make sure latest version is installed.


    # --------------------------------------------------------------------------
    # [Install] HashiCorp Stuff: Nomad
    # --------------------------------------------------------------------------

    # ------------------------------
    # Install
    # ------------------------------
    - name: Apt | Install | HashiCorp Nomad
      apt:
        name: nomad
        state: present # Just need something installed.
        # state: latest # Make sure latest version is installed.

    # ------------------------------
    # Configure
    # ------------------------------
    - name: Nomad | Root Directory | Create
      file:
        state: directory
        path: "/srv/nomad"
        owner: "nomad"
        group: "nomad"
        recurse: no

    #  If you do not run Nomad as root, make sure you add the Nomad user to the
    #  Docker group so Nomad can communicate with the Docker daemon.
    #    - https://www.nomadproject.io/docs/drivers/docker#client-requirements
    #  Just add it to the Docker group regardless?
    - name: Nomad | User Groups | Docker
      user:
        name: nomad
        groups: docker
        append: yes


    # --------------------------------------------------------------------------
    # [Install] HashiCorp Stuff: Consul
    # --------------------------------------------------------------------------

    - name: Apt | Install | HashiCorp Consul
      apt:
        name: consul
        state: present # Just need something installed.
        # state: latest # Make sure latest version is installed.

    # TODO: Rest of the Consul set-up / install?
    #   - Or does that come later?


    # --------------------------------------------------------------------------
    # [Install] Network File Share
    # --------------------------------------------------------------------------

    - name: Apt | Install | CIFS Utils (for NFS)
      apt:
        name: cifs-utils
        state: present


    # --------------------------------------------------------------------------
    # [Mount] Network File Shares
    # --------------------------------------------------------------------------

    - name: NFS | Root Directory | Create
      file:
        state: directory
        path: "/mnt/nfs"
        owner: "{{ os.user }}"
        group: "{{ os.group }}"
        recurse: no

    - name: NFS | Mount Directory
      include_tasks: "nfs.add-mount.yaml"
      with_items: "{{ nfs.mounts }}"
      loop_control:
        loop_var: mount_item


    # --------------------------------------------------------------------------
    # [Clean-Up]
    # --------------------------------------------------------------------------

    - name: Apt | Auto-Clean
      apt:
        autoclean: yes

    - name: Apt | Auto-Remove
      apt:
        autoremove: yes


  # # ==============================================================================
  # # Handlers
  # # ==============================================================================
  # handlers:
  #   # Restart `foo` service to pick up new config settings.
  #   - name: restart-service-foo
  #     service:
  #       name: foo
  #       state: restarted
